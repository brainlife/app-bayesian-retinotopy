#!/bin/bash
#PBS -l nodes=1:ppn=4,vmem=50gb,walltime=2:00:00
#PBS -N pRF
#PBS -V

fsdir=$(jq -r .output config.json)
prf_surfs=$(jq -r .prf_surfs config.json)

export SUBJECTS_DIR=`pwd`
cp -R $fsdir $SUBJECTS_DIR && cp -R $fsdir $SUBJECTS_DIR/$(basename $fsdir)_MNI

rm -R $SUBJECTS_DIR/$(basename $fsdir)_MNI/surf && mkdir $SUBJECTS_DIR/$(basename $fsdir)_MNI/surf



mkdir interpolated_prf_surfs
mkdir ret_output


time singularity exec -e docker://brainlife/mcr:r2019a ./compiled/main

time singularity exec -e docker://davhunt/neuropythy:1.5.1 python ./interpolate.py

time singularity exec -e docker://davhunt/neuropythy:1.5.1 bash -c "python -m neuropythy register_retinotopy output \
  --verbose \
  --lh-eccen=interpolated_prf_surfs/lh.benson14_eccentricity \
  --lh-angle=interpolated_prf_surfs/lh.benson14_polarAngle \
  --lh-weight=interpolated_prf_surfs/lh.benson14_r2 \
  --lh-radius=interpolated_prf_surfs/lh.benson14_rfWidth \
  --rh-eccen=interpolated_prf_surfs/rh.benson14_eccentricity \
  --rh-angle=interpolated_prf_surfs/rh.benson14_polarAngle \
  --rh-weight=interpolated_prf_surfs/rh.benson14_r2 \
  --rh-radius=interpolated_prf_surfs/rh.benson14_rfWidth \
  --subjects-dir=$(dirname $fsdir) \
  && cp -R ./$(basename $fsdir) ./ret_output" # in ./output/mri/inferred* and ./output/surf/inferred*




echo "converting output to nifti"
for i in ./ret_output/mri/*inferred*
do 
	mri_convert $i ${i%.*}.nii.gz
done

echo "organizing output"
mkdir -p prf/benson14_surfaces varea
mv ./ret_output/surf/*inferred* prf/benson14_surfaces
mv ./ret_output/mri/*inferred* prf

mv prf/inferred_eccen.nii.gz prf/eccentricity.nii.gz 
mv prf/inferred_sigma.nii.gz prf/rfWidth.nii.gz 
mv prf/inferred_angle.nii.gz prf/polarAngle.nii.gz 
mv prf/inferred_varea.nii.gz prf/varea.nii.gz 
cp prf/inferred_varea.nii.gz varea/parc.nii.gz

echo "running create_R2"
# this will create a binary mask R2 of 1's and 0's
# based on whether a voxel is assigned a visual area or not
./create_R2.py ./varea/parc.nii.gz

echo "creating vtks"
mkdir -p prf/surfaces
mris_convert --to-scanner $fsdir/surf/lh.white prf/surfaces/lh.white.vtk
mris_convert --to-scanner $fsdir/surf/rh.white prf/surfaces/rh.white.vtk
mris_convert --to-scanner $fsdir/surf/lh.pial prf/surfaces/lh.pial.vtk
mris_convert --to-scanner $fsdir/surf/rh.pial prf/surfaces/rh.pial.vtk
mris_convert --to-scanner $fsdir/surf/lh.sphere prf/surfaces/lh.sphere.vtk
mris_convert --to-scanner $fsdir/surf/rh.sphere prf/surfaces/rh.sphere.vtk
mris_convert --to-scanner $fsdir/surf/lh.inflated prf/surfaces/lh.inflated.vtk
mris_convert --to-scanner $fsdir/surf/rh.inflated prf/surfaces/rh.inflated.vtk

